<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT Vocabulary Tracker</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <header>
      <h1>JLPT Vocabulary Tracker</h1>

      <div class="controls">
        <!-- JLPT filter -->
        <label for="jlptFilter">JLPT Level:</label>
        <select id="jlptFilter">
          <option value="all">All</option>
          <option value="N1">N1</option>
          <option value="N2">N2</option>
          <option value="N3">N3</option>
          <option value="N4">N4</option>
          <option value="N5">N5</option>
        </select>

        <!-- Familiarity filter -->
        <label for="familiarityFilter">Familiarity:</label>
        <select id="familiarityFilter">
          <option value="all">All</option>
          <option value="well_known">Well Known</option>
          <option value="known">Known</option>
          <option value="explored">Explored</option>
          <option value="unknown">Unknown</option>
        </select>

        <!-- Favorites-only toggle -->
        <label for="favoritesOnly" style="display: flex; gap: 0.35rem">
          <input type="checkbox" id="favoritesOnly" />
          ‚≠ê Favorites only
        </label>

        <!-- Romaji toggle -->
        <label style="display: flex; gap: 0.35rem">
          <input type="checkbox" id="showRomaji" />
          Show Romaji
        </label>

        <!-- Data + stats controls -->
        <button id="resetProgress">üîÑ Reset Progress</button>
        <button id="exportData">‚¨áÔ∏è Export Data</button>
        <button id="importData">‚¨ÜÔ∏è Import Data</button>
        <input
          id="importFile"
          type="file"
          accept=".json"
          style="display: none"
        />
        <button id="toggleStats">üìä Show Stats</button>

        <!-- Today progress chip -->
        <span id="todayChip" class="chip">Progress Points Today: 0</span>
      </div>

      <!-- Simple toggle button for Ko-fi widget -->
      <button id="toggleKofi" style="margin-top: 10px">
        Hide Support Widget
      </button>

      <!-- Kanji appearance controls -->
      <div class="kanji-controls">
        <label for="kanjiSize">Kanji Size:</label>
        <input type="range" id="kanjiSize" min="0.9" max="2.5" step="0.1" />
        <span id="kanjiSizeValue">1.3rem</span>

        <label style="display: flex; align-items: center; gap: 0.25rem">
          <input type="checkbox" id="kanjiBoldToggle" />
          Bold Kanji
        </label>
      </div>
    </header>

    <!-- Stats panel -->
    <section id="statsPanel" class="hidden">
      <div id="statsContainer"></div>
    </section>

    <!-- Main grid for word cards -->
    <main id="wordGrid"></main>

    <!-- Pagination footer -->
    <footer>
      <button id="prevPage">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Next</button>
    </footer>

    <!-- Libraries + main script -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="script.js"></script>

    <!-- Ko-fi Floating Widget -->
    <script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script>
    <script>
      kofiWidgetOverlay.draw("danielgagepostma", {
        type: "floating-chat",
        "floating-chat.donateButton.text": "Support me",
        "floating-chat.donateButton.background-color": "#323842",
        "floating-chat.donateButton.text-color": "#fff",
      });

      // Helper: find the Ko-fi widget container, even if the ID changes
      function findKofiContainer() {
        const divs = document.querySelectorAll("div[id]");
        for (const el of divs) {
          const id = el.id.toLowerCase();
          if (id.includes("ko-fi") || id.includes("kofi")) {
            return el;
          }
        }
        return null;
      }

      function initKofiToggle() {
        const toggleBtn = document.getElementById("toggleKofi");
        if (!toggleBtn) return;

        let tries = 0;
        const maxTries = 40; // ~12 seconds at 300ms intervals

        const interval = setInterval(() => {
          const container = findKofiContainer();
          if (!container) {
            tries++;
            if (tries >= maxTries) {
              clearInterval(interval);
            }
            return;
          }

          clearInterval(interval);

          // Load saved state
          const hidden = localStorage.getItem("kofiHidden") === "true";
          if (hidden) {
            container.style.display = "none";
            toggleBtn.textContent = "Show Support Widget";
          } else {
            toggleBtn.textContent = "Hide Support Widget";
          }

          toggleBtn.addEventListener("click", () => {
            const isHidden = container.style.display === "none";
            if (isHidden) {
              container.style.display = "block";
              toggleBtn.textContent = "Hide Support Widget";
              localStorage.setItem("kofiHidden", "false");
            } else {
              container.style.display = "none";
              toggleBtn.textContent = "Show Support Widget";
              localStorage.setItem("kofiHidden", "true");
            }
          });
        }, 300);
      }

      window.addEventListener("load", initKofiToggle);
    </script>
  </body>
</html>
